import pandas as pd
import matplotlib.pyplot as plt
import pynwb
import os
import numpy as np
from neo.io import IgorIO
from pynwb import NWBHDF5IO
import elephant
import seaborn as sns
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots

from scipy.stats import sem

import plotly.io as pio
pio.renderers.default = "browser"

from acq_parameters import *
import pdb
from single_test import JaneCell

def main(csvfile, nwbfile):
    
    # gets sweep info for all cells
    sweep_info = pd.read_csv(csvfile, index_col=0)

    # reads in NWB file
    io = NWBHDF5IO(nwbfile, 'r', load_namespaces=True)
    nwbfile = io.read()

    #0 initializes JaneCell class
    cell = JaneCell(sweep_info, nwbfile)
    
    #1 drops depolarized and esc AP sweeps from VC data if applicable
    cell.drop_sweeps()

    #2 makes a dict for each cell, with stim condition as keys and all sweeps per stimulus as values
    cell.make_sweeps_dict()

    #3 runs stats on sweeps and creates a dict for each stim condition
    cell.make_cell_analysis_dict()

    #4 calculates power curve for plotting
    cell.make_power_curve_stats_df()

    #5 calculates response stats for plotting
    cell.make_stats_df()

    #6 makes plots for power curve and response stats
    #summary_plots = cell.graph_curve_stats()
    cell.make_mean_traces_df()
    cell.graph_response_trace()


if __name__ == "__main__":
    csvfile = '/home/jhuang/Documents/phd_projects/MMZ_STC_dataset/tables/non-injected_sweep_info.csv'
    nwbfile = '/home/jhuang/Documents/phd_projects/MMZ_STC_dataset/data/non-injected/JH20211103_c3.nwb'
    main(csvfile, nwbfile)
    print("I'm done")